@echo off
setlocal EnableExtensions EnableDelayedExpansion

rem ==============================================================================
rem new-java-project.bat (Windows CMD)
rem
rem Mirrors restored Linux new-java-project-linux.sh output/intent:
rem   - README.md + Quick Start
rem   - project_config.yaml
rem   - src/Main.java
rem   - scripts/build.bat, scripts/run.bat, scripts/clean.bat
rem   - .gitignore
rem   - build/ directory used for compiled classes
rem
rem Supports --ai / --tf as documentation only (no behavior), per your rule.
rem
rem Usage:
rem   new-java-project.bat --name <project_name> [--dir <base_dir>] [--ai] [--tf]
rem   new-java-project.bat --help
rem ==============================================================================

set "NAME="
set "BASE_DIR=D:\dev\projects"
set "AI_MODE=false"
set "TF_MODE=false"

:parse_args
if "%~1"=="" goto :validate_args

if /I "%~1"=="--help" goto :usage
if /I "%~1"=="-h" goto :usage

if /I "%~1"=="--name" (
  if "%~2"=="" (
    echo ERROR: --name requires a value
    exit /b 1
  )
  set "NAME=%~2"
  shift
  shift
  goto :parse_args
)

if /I "%~1"=="--dir" (
  if "%~2"=="" (
    echo ERROR: --dir requires a value
    exit /b 1
  )
  set "BASE_DIR=%~2"
  shift
  shift
  goto :parse_args
)

if /I "%~1"=="--ai" (
  set "AI_MODE=true"
  shift
  goto :parse_args
)

if /I "%~1"=="--tf" (
  set "TF_MODE=true"
  shift
  goto :parse_args
)

echo ERROR: Unknown argument: %~1 (use --help)
exit /b 1

:validate_args
if "%NAME%"=="" (
  echo ERROR: --name is required
  exit /b 1
)

echo %NAME% | findstr /R /C:"^[A-Za-z0-9._-][A-Za-z0-9._-]*$" >nul
if errorlevel 1 (
  echo ERROR: Invalid --name "%NAME%" ^(use only letters, digits, dot, underscore, hyphen^)
  exit /b 1
)

where javac >nul 2>&1
if errorlevel 1 (
  echo ERROR: javac not found in PATH
  echo        Install a JDK and ensure javac/java are available.
  exit /b 1
)

where java >nul 2>&1
if errorlevel 1 (
  echo ERROR: java not found in PATH
  echo        Install a JDK/JRE and ensure java is available.
  exit /b 1
)

set "PROJECT_DIR=%BASE_DIR%\%NAME%"

if not exist "%BASE_DIR%" mkdir "%BASE_DIR%" >nul 2>&1

if exist "%PROJECT_DIR%\" (
  for /f "delims=" %%G in ('dir /b "%PROJECT_DIR%" 2^>nul') do (
    echo ERROR: Project directory exists and is not empty:
    echo        "%PROJECT_DIR%"
    echo        Refusing to overwrite.
    exit /b 1
  )
) else (
  mkdir "%PROJECT_DIR%" >nul 2>&1
)

mkdir "%PROJECT_DIR%\src" >nul 2>&1
mkdir "%PROJECT_DIR%\scripts" >nul 2>&1
mkdir "%PROJECT_DIR%\build" >nul 2>&1

(
  echo build/
  echo *.class
  echo .DS_Store
) > "%PROJECT_DIR%\.gitignore"

(
  echo public class Main {
  echo     public static void main(String[] args) {
  echo         System.out.println("Hello from %NAME%!");
  echo     }
  echo }
) > "%PROJECT_DIR%\src\Main.java"

(
  echo @echo off
  echo setlocal EnableExtensions
  echo.
  echo if "%%~1"=="-h" goto :help
  echo if "%%~1"=="--help" goto :help
  echo.
  echo cd /d "%%~dp0\.."
  echo if not exist build mkdir build ^>nul 2^>^&1
  echo javac -d build src\Main.java
  echo if errorlevel 1 exit /b 1
  echo echo Build complete: build\Main.class
  echo exit /b 0
  echo.
  echo :help
  echo echo scripts\build.bat
  echo echo.
  echo echo Usage:
  echo echo   scripts\build.bat
  echo exit /b 0
) > "%PROJECT_DIR%\scripts\build.bat"

(
  echo @echo off
  echo setlocal EnableExtensions
  echo.
  echo if "%%~1"=="-h" goto :help
  echo if "%%~1"=="--help" goto :help
  echo.
  echo cd /d "%%~dp0\.."
  echo call scripts\build.bat
  echo if errorlevel 1 exit /b 1
  echo java -cp build Main
  echo exit /b %%errorlevel%%
  echo.
  echo :help
  echo echo scripts\run.bat
  echo echo.
  echo echo Usage:
  echo echo   scripts\run.bat
  echo echo.
  echo echo Builds first, then runs.
  echo exit /b 0
) > "%PROJECT_DIR%\scripts\run.bat"

(
  echo @echo off
  echo setlocal EnableExtensions
  echo.
  echo if "%%~1"=="-h" goto :help
  echo if "%%~1"=="--help" goto :help
  echo.
  echo cd /d "%%~dp0\.."
  echo if exist build rmdir /s /q build
  echo echo Cleaned build\
  echo exit /b 0
  echo.
  echo :help
  echo echo scripts\clean.bat
  echo echo.
  echo echo Usage:
  echo echo   scripts\clean.bat
  echo exit /b 0
) > "%PROJECT_DIR%\scripts\clean.bat"

(
  echo project:
  echo   name: "%NAME%"
  echo   type: "java"
  echo   created_at: ""
  echo   template_version: "1.0.0"
  echo.
  echo java:
  echo   toolchain: "openjdk"
  echo   notes:
  echo     - "This template uses javac/java directly (no Maven/Gradle)."
  echo.
  echo flags:
  echo   ai_ml: %AI_MODE%
  echo   tensorflow: %TF_MODE%
) > "%PROJECT_DIR%\project_config.yaml"

(
  echo # %NAME%
  echo.
  echo This project was generated by **new-java-project.bat** on Windows.
  echo.
  echo ## Quick Start (Windows)
  echo ```bat
  echo scripts\run.bat
  echo ```
  echo.
  echo ## What got generated
  echo - `project_config.yaml`: toolchain expectations
  echo - `src/Main.java`: runnable entrypoint
  echo - `scripts\build.bat`, `scripts\run.bat`, `scripts\clean.bat`
  echo.
  echo ## Requirements
  echo - Java (JDK) installed and `javac` available on PATH
  echo.
  if /I "%TF_MODE%"=="true" (
    echo ## TensorFlow note (Java)
    echo - Prefer DJL, ONNX Runtime, or a Python service for TensorFlow-heavy workflows.
  )
) > "%PROJECT_DIR%\README.md"

echo Created Java project at:
echo   "%PROJECT_DIR%"
echo Next:
echo   cd /d "%PROJECT_DIR%"
echo   scripts\run.bat
exit /b 0

:usage
echo.
echo new-java-project.bat
echo.
echo Usage:
echo   new-java-project.bat --name ^<project_name^> [--dir ^<base_dir^>] [--ai] [--tf]
echo.
exit /b 0
