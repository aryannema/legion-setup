@echo off
setlocal EnableExtensions EnableDelayedExpansion

rem ==============================================================================
rem new-python-project.bat  (Windows CMD)
rem
rem Mirrors restored Linux new-python-project-linux.sh intent/output:
rem   - README.md + Quick Start
rem   - project_config.yaml
rem   - pyproject.toml
rem   - requirements.txt
rem   - src/main.py
rem   - scripts/run.bat, scripts/dev.bat, scripts/test.bat, scripts/lint.bat
rem   - .gitignore
rem
rem Windows rules:
rem   - No PowerShell
rem   - No setup-aryan runtime
rem   - No state/log files
rem   - No idempotency beyond "refuse overwrite if dir exists and not empty"
rem
rem Fixed layout (per your Windows authority):
rem   Tools   : D:\dev\tools
rem   Caches  : D:\dev\cache
rem   Projects: D:\dev\projects
rem
rem Prereqs:
rem   - conda on PATH
rem   - uv on PATH
rem
rem Usage:
rem   new-python-project.bat --name <project_name> [--dir <base_dir>] [--ai] [--tf]
rem   new-python-project.bat --help
rem ==============================================================================

set "ACTION_NAME=new-python-project"
set "NAME="
set "BASE_DIR=D:\dev\projects"
set "AI_MODE=false"
set "TF_MODE=false"

:parse_args
if "%~1"=="" goto :validate_args

if /I "%~1"=="--help" goto :usage
if /I "%~1"=="-h" goto :usage

if /I "%~1"=="--name" (
  if "%~2"=="" (
    echo ERROR: --name requires a value
    exit /b 1
  )
  set "NAME=%~2"
  shift
  shift
  goto :parse_args
)

if /I "%~1"=="--dir" (
  if "%~2"=="" (
    echo ERROR: --dir requires a value
    exit /b 1
  )
  set "BASE_DIR=%~2"
  shift
  shift
  goto :parse_args
)

if /I "%~1"=="--ai" (
  set "AI_MODE=true"
  shift
  goto :parse_args
)

if /I "%~1"=="--tf" (
  set "TF_MODE=true"
  shift
  goto :parse_args
)

echo ERROR: Unknown argument: %~1 (use --help)
exit /b 1

:validate_args
if "%NAME%"=="" (
  echo ERROR: --name is required
  exit /b 1
)

rem Validate name matches Linux regex: ^[a-zA-Z0-9._-]+$
echo %NAME% | findstr /R /C:"^[A-Za-z0-9._-][A-Za-z0-9._-]*$" >nul
if errorlevel 1 (
  echo ERROR: Invalid --name "%NAME%" ^(use only letters, digits, dot, underscore, hyphen^)
  exit /b 1
)

rem Tool checks (best-effort; Linux assumes toolchain action already done)
where conda >nul 2>&1
if errorlevel 1 (
  echo ERROR: conda not found in PATH
  exit /b 1
)

where uv >nul 2>&1
if errorlevel 1 (
  echo ERROR: uv not found in PATH
  exit /b 1
)

set "PROJECT_DIR=%BASE_DIR%\%NAME%"

rem Ensure base dir exists
if not exist "%BASE_DIR%" mkdir "%BASE_DIR%" >nul 2>&1

rem Refuse overwrite if dir exists and not empty
if exist "%PROJECT_DIR%\" (
  for /f "delims=" %%G in ('dir /b "%PROJECT_DIR%" 2^>nul') do (
    echo ERROR: Project directory exists and is not empty:
    echo        "%PROJECT_DIR%"
    echo        Refusing to overwrite.
    exit /b 1
  )
) else (
  mkdir "%PROJECT_DIR%" >nul 2>&1
)

rem Create dirs
mkdir "%PROJECT_DIR%\src" >nul 2>&1
mkdir "%PROJECT_DIR%\scripts" >nul 2>&1

rem ------------------------------------------------------------------------------
rem .gitignore (Linux-like)
rem ------------------------------------------------------------------------------
(
  echo .venv/
  echo __pycache__/
  echo *.pyc
  echo .pytest_cache/
  echo .coverage
  echo dist/
  echo build/
  echo *.egg-info/
  echo .env
  echo .DS_Store
) > "%PROJECT_DIR%\.gitignore"

rem ------------------------------------------------------------------------------
rem requirements.txt (Linux: empty starter comments)
rem For Windows parity we keep the same comment style; if --tf, we add tensorflow.
rem ------------------------------------------------------------------------------
(
  echo # Add your Python deps here (pip-style^), then run:
  echo #   uv pip install -r requirements.txt
  if /I "%TF_MODE%"=="true" (
    echo tensorflow
  )
) > "%PROJECT_DIR%\requirements.txt"

rem ------------------------------------------------------------------------------
rem pyproject.toml (matches restored Linux minimal)
rem ------------------------------------------------------------------------------
(
  echo [project]
  echo name = "%NAME%"
  echo version = "0.1.0"
  echo description = "%NAME% (generated by new-python-project.bat)"
  echo readme = "README.md"
  echo requires-python = ">=3.11"
  echo.
  echo [tool.uv]
  echo # uv will create and manage a local .venv by default if you use 'uv venv'
  echo # Here we keep it simple and let conda own the interpreter, uv owns pip installs.
) > "%PROJECT_DIR%\pyproject.toml"

rem ------------------------------------------------------------------------------
rem src/main.py (matches restored Linux message/intent)
rem ------------------------------------------------------------------------------
(
  echo def main() ^-^> None:
  echo     print("Hello from %NAME%!")
  echo     print("If this is an AI/ML project, activate your conda env and install deps via uv.")
  echo.
  echo if __name__ == "__main__":
  echo     main()
) > "%PROJECT_DIR%\src\main.py"

rem ------------------------------------------------------------------------------
rem scripts/run.bat  (Linux: python3 ./src/main.py)
rem We do the same: rely on current python in PATH (user activates conda env).
rem ------------------------------------------------------------------------------
(
  echo @echo off
  echo setlocal EnableExtensions
  echo.
  echo if "%%~1"=="-h" goto :help
  echo if "%%~1"=="--help" goto :help
  echo.
  echo cd /d "%%~dp0\.."
  echo python src\main.py
  echo exit /b %%errorlevel%%
  echo.
  echo :help
  echo echo scripts\run.bat
  echo echo.
  echo echo Usage:
  echo echo   scripts\run.bat
  echo echo.
  echo echo Notes:
  echo echo   - Activate your conda env first so python points to the right interpreter.
  echo exit /b 0
) > "%PROJECT_DIR%\scripts\run.bat"

rem ------------------------------------------------------------------------------
rem scripts/dev.bat  (Linux: prints notes, then runs)
rem ------------------------------------------------------------------------------
(
  echo @echo off
  echo setlocal EnableExtensions
  echo.
  echo if "%%~1"=="-h" goto :help
  echo if "%%~1"=="--help" goto :help
  echo.
  echo cd /d "%%~dp0\.."
  echo call scripts\run.bat
  echo exit /b %%errorlevel%%
  echo.
  echo :help
  echo echo scripts\dev.bat
  echo echo.
  echo echo Usage:
  echo echo   scripts\dev.bat
  echo echo.
  echo echo Notes:
  echo echo   - For conda+uv workflow:
  echo echo       conda activate ^<env^>
  echo echo       uv pip install -r requirements.txt
  echo exit /b 0
) > "%PROJECT_DIR%\scripts\dev.bat"

rem ------------------------------------------------------------------------------
rem scripts/test.bat  (Linux: no tests scaffolded)
rem ------------------------------------------------------------------------------
(
  echo @echo off
  echo setlocal EnableExtensions
  echo.
  echo if "%%~1"=="-h" goto :help
  echo if "%%~1"=="--help" goto :help
  echo.
  echo echo No tests configured yet.
  echo exit /b 0
  echo.
  echo :help
  echo echo scripts\test.bat
  echo echo.
  echo echo Usage:
  echo echo   scripts\test.bat
  echo echo.
  echo echo Default:
  echo echo   - No tests scaffolded yet.
  echo echo   - Add pytest to requirements.txt and create tests\ later.
  echo exit /b 0
) > "%PROJECT_DIR%\scripts\test.bat"

rem ------------------------------------------------------------------------------
rem scripts/lint.bat  (Linux: suggests ruff/black)
rem ------------------------------------------------------------------------------
(
  echo @echo off
  echo setlocal EnableExtensions
  echo.
  echo if "%%~1"=="-h" goto :help
  echo if "%%~1"=="--help" goto :help
  echo.
  echo echo No lint configured yet. Use --help for suggestions.
  echo exit /b 0
  echo.
  echo :help
  echo echo scripts\lint.bat
  echo echo.
  echo echo Usage:
  echo echo   scripts\lint.bat
  echo echo.
  echo echo Tip:
  echo echo   - Add ruff/black to requirements.txt and run via uv:
  echo echo       uv pip install ruff black
  echo echo       ruff check .
  echo echo       black --check .
  echo exit /b 0
) > "%PROJECT_DIR%\scripts\lint.bat"

rem ------------------------------------------------------------------------------
rem TensorFlow extras (Windows-only requirement from you: explicit + validated)
rem ------------------------------------------------------------------------------
if /I "%TF_MODE%"=="true" (
  (
    echo import os
    echo import time
    echo.
    echo os.environ.setdefault("TF_CPP_MIN_LOG_LEVEL", "1")
    echo.
    echo import tensorflow as tf  # noqa: E402
    echo.
    echo.
    echo def main() ^-^> None:
    echo     print("TensorFlow:", tf.__version__)
    echo     gpus = tf.config.list_physical_devices("GPU")
    echo     print("GPUs:", gpus)
    echo.
    echo     # Best-effort: avoid greedy VRAM allocation
    echo     for g in gpus:
    echo         try:
    echo             tf.config.experimental.set_memory_growth(g, True)
    echo         except Exception as e:
    echo             print("Could not set memory growth:", e)
    echo.
    echo     a = tf.random.uniform((2048, 2048))
    echo     b = tf.random.uniform((2048, 2048))
    echo.
    echo     t0 = time.time()
    echo     c = tf.linalg.matmul(a, b)
    echo     _ = c.numpy()
    echo     t1 = time.time()
    echo.
    echo     print("Matmul OK. Seconds:", round(t1 - t0, 3))
    echo     print("First run can be slower due to CUDA/PTX/XLA warmup.")
    echo.
    echo.
    echo if __name__ == "__main__":
    echo     main()
  ) > "%PROJECT_DIR%\src\validate_tf.py"

  (
    echo @echo off
    echo setlocal EnableExtensions
    echo.
    echo if "%%~1"=="-h" goto :help
    echo if "%%~1"=="--help" goto :help
    echo.
    echo cd /d "%%~dp0\.."
    echo python src\validate_tf.py
    echo exit /b %%errorlevel%%
    echo.
    echo :help
    echo echo scripts\validate_tf.bat
    echo echo.
    echo echo Usage:
    echo echo   scripts\validate_tf.bat
    echo echo.
    echo echo Notes:
    echo echo   - Activate your conda env first.
    echo echo   - First GPU run may be slower due to warmup/compilation.
    echo exit /b 0
  ) > "%PROJECT_DIR%\scripts\validate_tf.bat"
)

rem ------------------------------------------------------------------------------
rem project_config.yaml (Windows paths + flags, mirrors Linux intent)
rem ------------------------------------------------------------------------------
(
  echo project:
  echo   name: "%NAME%"
  echo   type: "python"
  echo   created_at: ""
  echo   template_version: "1.0.0"
  echo.
  echo python:
  echo   toolchain: "conda+uv"
  echo   caches:
  echo     uv_cache_dir: "D:\dev\cache\uv"
  echo     conda_pkgs_dir: "D:\dev\cache\conda-pkgs"
  echo     conda_envs_dir: "D:\dev\tools\envs\conda"
  echo.
  echo ai_ml:
  echo   enabled: %AI_MODE%
  echo.
  echo tensorflow:
  echo   enabled: %TF_MODE%
) > "%PROJECT_DIR%\project_config.yaml"

rem ------------------------------------------------------------------------------
rem README.md (Windows Quick Start; mirrors Linux steps but for CMD paths)
rem ------------------------------------------------------------------------------
(
  echo # %NAME%
  echo.
  echo This project was generated by **new-python-project.bat** on Windows.
  echo.
  echo ## Quick Start (Windows)
  echo.
  echo ### 1^) Create a conda environment (skeleton) and activate it
  echo Choose an env name, for example: `%NAME%-py`
  echo.
  echo ```bat
  echo conda create -n %NAME%-py python=3.11 -y
  echo conda activate %NAME%-py
  echo ```
  echo.
  echo ### 2^) Install Python dependencies using uv (inside the active conda env)
  echo ```bat
  echo uv pip install -r requirements.txt
  echo ```
  echo.
  echo ### 3^) Run
  echo ```bat
  echo scripts\run.bat
  echo ```
  echo.
  echo ## What got generated
  echo - `project_config.yaml`: records toolchain + cache expectations
  echo - `pyproject.toml`: minimal project metadata (tooling-friendly)
  echo - `requirements.txt`: add dependencies here
  echo - `src/main.py`: runnable entrypoint
  echo - `scripts\*.bat`: helper runners (run/dev/test/lint)
  if /I "%TF_MODE%"=="true" (
    echo - `src\validate_tf.py` + `scripts\validate_tf.bat`: TensorFlow validation
  )
  echo.
  echo ## Notes on disk usage (conda + uv)
  echo - Projects: `D:\dev\projects`
  echo - Caches: `D:\dev\cache` (uv, conda pkgs, etc.)
  echo - Tools/envs: `D:\dev\tools`
  echo.
  if /I "%TF_MODE%"=="true" (
    echo ## TensorFlow workflow (Windows)
    echo - Install: `uv pip install -r requirements.txt` (tensorflow is included)
    echo - Validate:
    echo ```bat
    echo scripts\validate_tf.bat
    echo ```
    echo - First run can be slower due to CUDA/PTX/XLA warm-up; run validation once before judging notebook responsiveness.
  )
) > "%PROJECT_DIR%\README.md"

echo Created Python project at:
echo   "%PROJECT_DIR%"
echo.
echo Next (Windows):
echo   cd /d "%PROJECT_DIR%"
echo   conda create -n %NAME%-py python=3.11 -y
echo   conda activate %NAME%-py
echo   uv pip install -r requirements.txt
echo   scripts\run.bat
if /I "%TF_MODE%"=="true" (
  echo   scripts\validate_tf.bat
)
exit /b 0

:usage
echo.
echo %ACTION_NAME%
echo.
echo Usage:
echo   new-python-project.bat --name ^<project_name^> [--dir ^<base_dir^>] [--ai] [--tf]
echo   new-python-project.bat --help
echo.
exit /b 0
