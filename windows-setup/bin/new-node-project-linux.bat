@echo off
setlocal EnableExtensions EnableDelayedExpansion

rem ==============================================================================
rem new-node-project.bat (Windows CMD)
rem
rem Mirrors restored Linux new-node-project-linux.sh output/intent:
rem   - README.md + Quick Start
rem   - project_config.yaml
rem   - package.json
rem   - src/index.js
rem   - scripts/dev.bat, scripts/run.bat, scripts/test.bat
rem   - .gitignore
rem
rem Supports --ai / --tf as documentation only (no behavior), per your rule.
rem
rem Usage:
rem   new-node-project.bat --name <project_name> [--dir <base_dir>] [--ai] [--tf]
rem   new-node-project.bat --help
rem ==============================================================================

set "NAME="
set "BASE_DIR=D:\dev\projects"
set "AI_MODE=false"
set "TF_MODE=false"

:parse_args
if "%~1"=="" goto :validate_args

if /I "%~1"=="--help" goto :usage
if /I "%~1"=="-h" goto :usage

if /I "%~1"=="--name" (
  if "%~2"=="" (
    echo ERROR: --name requires a value
    exit /b 1
  )
  set "NAME=%~2"
  shift
  shift
  goto :parse_args
)

if /I "%~1"=="--dir" (
  if "%~2"=="" (
    echo ERROR: --dir requires a value
    exit /b 1
  )
  set "BASE_DIR=%~2"
  shift
  shift
  goto :parse_args
)

if /I "%~1"=="--ai" (
  set "AI_MODE=true"
  shift
  goto :parse_args
)

if /I "%~1"=="--tf" (
  set "TF_MODE=true"
  shift
  goto :parse_args
)

echo ERROR: Unknown argument: %~1 (use --help)
exit /b 1

:validate_args
if "%NAME%"=="" (
  echo ERROR: --name is required
  exit /b 1
)

echo %NAME% | findstr /R /C:"^[A-Za-z0-9._-][A-Za-z0-9._-]*$" >nul
if errorlevel 1 (
  echo ERROR: Invalid --name "%NAME%" ^(use only letters, digits, dot, underscore, hyphen^)
  exit /b 1
)

set "PROJECT_DIR=%BASE_DIR%\%NAME%"

if not exist "%BASE_DIR%" mkdir "%BASE_DIR%" >nul 2>&1

if exist "%PROJECT_DIR%\" (
  for /f "delims=" %%G in ('dir /b "%PROJECT_DIR%" 2^>nul') do (
    echo ERROR: Project directory exists and is not empty:
    echo        "%PROJECT_DIR%"
    echo        Refusing to overwrite.
    exit /b 1
  )
) else (
  mkdir "%PROJECT_DIR%" >nul 2>&1
)

mkdir "%PROJECT_DIR%\src" >nul 2>&1
mkdir "%PROJECT_DIR%\scripts" >nul 2>&1

(
  echo node_modules/
  echo dist/
  echo build/
  echo .env
  echo .DS_Store
) > "%PROJECT_DIR%\.gitignore"

(
  echo {
  echo   "name": "%NAME%",
  echo   "version": "0.1.0",
  echo   "private": true,
  echo   "type": "module",
  echo   "scripts": {
  echo     "dev": "node ./src/index.js",
  echo     "start": "node ./src/index.js",
  echo     "test": "echo \"No tests yet\" ^&^& exit 0"
  echo   }
  echo }
) > "%PROJECT_DIR%\package.json"

(
  echo console.log('Hello from %NAME%!');
) > "%PROJECT_DIR%\src\index.js"

(
  echo @echo off
  echo setlocal EnableExtensions
  echo.
  echo if "%%~1"=="-h" goto :help
  echo if "%%~1"=="--help" goto :help
  echo.
  echo cd /d "%%~dp0\.."
  echo pnpm -s run start
  echo exit /b %%errorlevel%%
  echo.
  echo :help
  echo echo scripts\run.bat
  echo echo.
  echo echo Usage:
  echo echo   scripts\run.bat
  echo exit /b 0
) > "%PROJECT_DIR%\scripts\run.bat"

(
  echo @echo off
  echo setlocal EnableExtensions
  echo.
  echo if "%%~1"=="-h" goto :help
  echo if "%%~1"=="--help" goto :help
  echo.
  echo cd /d "%%~dp0\.."
  echo pnpm -s run dev
  echo exit /b %%errorlevel%%
  echo.
  echo :help
  echo echo scripts\dev.bat
  echo echo.
  echo echo Usage:
  echo echo   scripts\dev.bat
  echo echo.
  echo echo First time:
  echo echo   pnpm install
  echo exit /b 0
) > "%PROJECT_DIR%\scripts\dev.bat"

(
  echo @echo off
  echo setlocal EnableExtensions
  echo.
  echo if "%%~1"=="-h" goto :help
  echo if "%%~1"=="--help" goto :help
  echo.
  echo cd /d "%%~dp0\.."
  echo pnpm -s run test
  echo exit /b %%errorlevel%%
  echo.
  echo :help
  echo echo scripts\test.bat
  echo echo.
  echo echo Usage:
  echo echo   scripts\test.bat
  echo exit /b 0
) > "%PROJECT_DIR%\scripts\test.bat"

(
  echo project:
  echo   name: "%NAME%"
  echo   type: "node"
  echo   created_at: ""
  echo   template_version: "1.0.0"
  echo.
  echo node:
  echo   toolchain: "node+pnpm"
  echo   caches:
  echo     pnpm_store_dir: "D:\dev\cache\pnpm-store"
  echo     npm_cache_dir: "D:\dev\cache\npm-cache"
  echo.
  echo flags:
  echo   ai_ml: %AI_MODE%
  echo   tensorflow: %TF_MODE%
) > "%PROJECT_DIR%\project_config.yaml"

(
  echo # %NAME%
  echo.
  echo This project was generated by **new-node-project.bat** on Windows.
  echo.
  echo ## Quick Start (Windows)
  echo ```bat
  echo pnpm install
  echo pnpm run dev
  echo ```
  echo.
  echo ## What got generated
  echo - `project_config.yaml`: toolchain + cache expectations
  echo - `package.json`: minimal scripts
  echo - `src/index.js`: runnable entrypoint
  echo - `scripts\*.bat`: helper runners
  echo.
  echo ## Notes on disk usage (pnpm)
  echo - pnpm uses a global store (hard-links where possible) to prevent node_modules duplication.
  echo - Expected caches under `D:\dev\cache`.
  echo.
  if /I "%TF_MODE%"=="true" (
    echo ## TensorFlow note (Node)
    echo - Node is not the preferred runtime for TensorFlow on Windows dev workflows.
    echo - Better options: Python service, ONNX Runtime, or tfjs for lightweight browser/runtime use.
  )
) > "%PROJECT_DIR%\README.md"

echo Created Node project at:
echo   "%PROJECT_DIR%"
echo Next:
echo   cd /d "%PROJECT_DIR%"
echo   pnpm install
echo   pnpm run dev
exit /b 0

:usage
echo.
echo new-node-project.bat
echo.
echo Usage:
echo   new-node-project.bat --name ^<project_name^> [--dir ^<base_dir^>] [--ai] [--tf]
echo.
exit /b 0
