#!/usr/bin/env bash
# setup-aryan
#
# Prerequisites:
# - Staged via: sudo ./linux-setup/stage-aryan-setup.sh
#
# Usage:
#   setup-aryan --help
#   setup-aryan list
#   setup-aryan run <action> [--force] [-- <action args...>]
#   setup-aryan <action> [--force] [-- <action args...>]
#   setup-aryan version
#
# Notes:
# - Logs:  /var/log/setup-aryan/
# - State: /var/log/setup-aryan/state-files/   (NO JSON, key=value .state)

set -euo pipefail

LOG_ROOT="/var/log/setup-aryan"
STATE_ROOT="/var/log/setup-aryan/state-files"
WRAPPER_LOG="${LOG_ROOT}/setup-aryan.log"
VERSION="1.1.0"

BIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "${BIN_DIR}/.." && pwd)"
ACTIONS_DIR="${ROOT_DIR}/actions"

usage() {
  cat <<USAGE
setup-aryan (Linux)

Usage:
  setup-aryan --help
  setup-aryan list
  setup-aryan run <action> [--force] [-- <action args...>]
  setup-aryan <action> [--force] [-- <action args...>]
  setup-aryan version

Paths:
  Actions: ${ACTIONS_DIR}
  Logs:    ${LOG_ROOT}
  State:   ${STATE_ROOT}  (key=value .state; NO JSON)

Examples:
  setup-aryan list
  setup-aryan run install-python-toolchain-linux --force
  setup-aryan new-python-project-linux -- --name myproj --ai --tensorflow
USAGE
}

ist_stamp() { TZ="Asia/Kolkata" date '+IST %d-%m-%Y %H:%M:%S'; }

log_line() {
  local level="$1"; shift
  local msg="$*"
  mkdir -p "${LOG_ROOT}" >/dev/null 2>&1 || true
  printf '%s %s %s\n' "$(ist_stamp)" "${level}" "${msg}" | tee -a "${WRAPPER_LOG}" >/dev/null
}

ensure_env() {
  if [[ ! -d "${ACTIONS_DIR}" ]]; then
    echo "ERROR: Actions directory not found: ${ACTIONS_DIR}" >&2
    echo "Did you run: sudo ./linux-setup/stage-aryan-setup.sh ?" >&2
    exit 1
  fi
  if [[ ! -d "${LOG_ROOT}" ]]; then
    # wrapper should not force sudo; best effort only
    mkdir -p "${LOG_ROOT}" 2>/dev/null || true
  fi
  if [[ ! -d "${STATE_ROOT}" ]]; then
    mkdir -p "${STATE_ROOT}" 2>/dev/null || true
  fi
}

list_actions() {
  ensure_env
  echo "Actions (from ${ACTIONS_DIR}):"
  local f
  shopt -s nullglob
  for f in "${ACTIONS_DIR}"/*.sh; do
    local base
    base="$(basename "$f")"
    base="${base%.sh}"
    [[ "${base}" == _* ]] && continue
    echo "  - ${base}"
  done
}

show_version() {
  echo "${VERSION}"
}

resolve_action() {
  local name="$1"
  local path="${ACTIONS_DIR}/${name}.sh"
  [[ -f "${path}" ]] && echo "${path}" || echo ""
}

invoke_action() {
  local action="$1"; shift
  local force="$1"; shift

  ensure_env

  local path
  path="$(resolve_action "${action}")"
  if [[ -z "${path}" ]]; then
    log_line "Error" "Unknown action: ${action}"
    echo "Try: setup-aryan list" >&2
    exit 2
  fi

  local args=()
  if [[ "${force}" == "true" ]]; then
    args+=(--force)
  fi
  args+=("$@")

  log_line "Info" "Running action: ${action} ${args[*]:-}"
  # shellcheck disable=SC2068
  "${path}" ${args[@]}
}

main() {
  if [[ $# -lt 1 ]]; then
    usage
    exit 1
  fi

  local cmd="$1"; shift || true
  case "${cmd}" in
    -h|--help|help) usage; exit 0 ;;
    version) show_version; exit 0 ;;
    list) list_actions; exit 0 ;;
    run)
      if [[ $# -lt 1 ]]; then
        echo "ERROR: Missing action name." >&2
        usage
        exit 1
      fi
      local action="$1"; shift
      local force="false"
      local forwarded=()

      # Collect args; support -- separator
      while [[ $# -gt 0 ]]; do
        case "$1" in
          --force) force="true"; shift ;;
          --) shift; forwarded+=("$@"); break ;;
          *) forwarded+=("$1"); shift ;;
        esac
      done

      invoke_action "${action}" "${force}" "${forwarded[@]}"
      exit 0
      ;;
    *)
      # Treat cmd as action name
      local action="${cmd}"
      local force="false"
      local forwarded=()

      # cmd can be followed by args; support --force and --
      while [[ $# -gt 0 ]]; do
        case "$1" in
          --force) force="true"; shift ;;
          --) shift; forwarded+=("$@"); break ;;
          *) forwarded+=("$1"); shift ;;
        esac
      done

      invoke_action "${action}" "${force}" "${forwarded[@]}"
      exit 0
      ;;
  esac
}

main "$@"
